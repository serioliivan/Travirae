<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <title>Area affiliati – Travirae</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/png" href="assets/img/common/plane-logo.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body class="page page--affiliate-portal">
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="index.html">
      <img src="assets/img/common/plane-logo.png" alt="Travirae" style="height:28px;"/>
      <span>Travirae</span>
    </a>
    <nav class="main-nav">
      <a class="nav-link" href="index.html">Hotel</a>
      <a class="nav-link" href="flights.html">Voli</a>
      <a class="nav-link active" href="programma-affiliato.html">Programma affiliato</a>
    </nav>
    <button class="nav-toggle" aria-label="Apri menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>
</header>

<main class="section">
  <div class="container affiliate-layout">
    <div class="affiliate-intro">
      <h1>Area affiliati Travirae</h1>
      <p>Gestisci il tuo Affiliate ID, i link tracciati e monitora in tempo quasi reale le performance generate dal tuo traffico.</p>
      <ul>
        <li>Revenue share dal <strong>40%</strong> al <strong>60%</strong> sulle commissioni nette Travirae.</li>
        <li>Click e vendite tracciate automaticamente tramite Travelpayouts e Stay22.</li>
        <li>Payout mensile a partire da <strong>50 USD</strong>.</li>
      </ul>
    </div>
    <div class="auth-card" id="affiliate-app">
      <p>Caricamento area affiliati…</p>
    </div>
  </div>
</main>

<footer class="mega-footer">
  <div class="container mf-bottom muted small">
    <div>© <span id="year-copy"></span> Travirae · Tutti i diritti riservati</div>
    <div class="mf-legal">
      <a href="privacy.html">Privacy</a> · <a href="termini.html">Termini</a> · <a href="cookie.html">Cookie</a>
    </div>
  </div>
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://qihaslaxdfwounujpeuf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpaGFzbGF4ZGZ3b3VudWpwZXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzE5MTMsImV4cCI6MjA4MDYwNzkxM30.scqVi4SjN76Oqr3FVtHt5OZWcn8Zh7LyTgU-H4bNEdo';
  window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script src="assets/js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function(){
  var supabase = window.supabaseClient;
  var app = document.getElementById('affiliate-app');

  function setContent(html){
    app.innerHTML = html;
  }

  function showMessage(msg, type){
    var box = app.querySelector('.auth-message');
    if (!box) return;
    box.textContent = msg || '';
    box.classList.remove('auth-message--success','auth-message--error');
    if (type === 'success') box.classList.add('auth-message--success');
    if (type === 'error') box.classList.add('auth-message--error');
  }

  function renderTabs(active){
    return '' +
    '<div class="auth-tabs">' +
      '<button class="auth-tab ' + (active==='login' ? 'auth-tab--active' : '') + '" data-view="login">Accedi</button>' +
      '<button class="auth-tab ' + (active==='signup' ? 'auth-tab--active' : '') + '" data-view="signup">Registrati</button>' +
    '</div>';
  }

  function bindTabs(){
    var tabs = app.querySelectorAll('.auth-tab');
    tabs.forEach(function(btn){
      btn.addEventListener('click', function(){
        var view = btn.getAttribute('data-view');
        if (view === 'login') renderLoginView();
        if (view === 'signup') renderSignupView();
      });
    });
  }

  function renderLoginView(message){
    setContent(
      renderTabs('login') +
      '<div class="auth-message ' + (message ? 'auth-message--error' : '') + '">' + (message || '') + '</div>' +
      '<form class="auth-form" id="login-form">' +
        '<label>Email<br/><input type="email" name="email" required /></label>' +
        '<label>Password<br/><input type="password" name="password" required /></label>' +
        '<div class="auth-actions">' +
          '<span class="auth-link" data-action="forgot">Password dimenticata?</span>' +
        '</div>' +
        '<button type="submit" class="btn-auth">Accedi</button>' +
      '</form>'
    );
    bindTabs();
    var form = app.querySelector('#login-form');
    form.addEventListener('submit', function(e){
      e.preventDefault();
      showMessage('Accesso in corso…');
      var email = form.email.value.trim();
      var password = form.password.value.trim();
      supabase.auth.signInWithPassword({ email: email, password: password })
        .then(function(result){
          if (result.error){
            showMessage(result.error.message || 'Accesso non riuscito', 'error');
            return;
          }
          showDashboard();
        });
    });
    var forgot = app.querySelector('[data-action="forgot"]');
    forgot.addEventListener('click', renderForgotView);
  }

  function renderSignupView(message, isSuccess){
    setContent(
      renderTabs('signup') +
      '<div class="auth-message ' + (message ? (isSuccess ? 'auth-message--success' : 'auth-message--error') : '') + '">' +
        (message || '') +
      '</div>' +
      '<form class="auth-form" id="signup-form">' +
        '<label>Email<br/><input type="email" name="email" required /></label>' +
        '<label>Password<br/><input type="password" name="password" required minlength="6" /></label>' +
        '<label>Conferma password<br/><input type="password" name="password2" required minlength="6" /></label>' +
        '<button type="submit" class="btn-auth">Crea account</button>' +
        '<p class="auth-note">Ti invieremo un\'email per confermare il tuo account. Dopo la conferma potrai accedere da qui.</p>' +
      '</form>'
    );
    bindTabs();
    var form = app.querySelector('#signup-form');
    form.addEventListener('submit', function(e){
      e.preventDefault();
      var email = form.email.value.trim();
      var password = form.password.value.trim();
      var password2 = form.password2.value.trim();
      if (password !== password2){
        renderSignupView('Le password non coincidono', false);
        return;
      }
      renderSignupView('Registrazione in corso…', true);
      supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          emailRedirectTo: 'https://travirae.com/area-affiliati.html?email_confirmed=1'
        }
      }).then(function(result){
        if (result.error){
          renderSignupView(result.error.message || 'Registrazione non riuscita', false);
          return;
        }
        renderSignupView('Registrazione completata! Controlla la posta e conferma la tua email, poi accedi.', true);
      });
    });
  }

  function renderForgotView(){
    setContent(
      '<div class="auth-tabs">' +
        '<button class="auth-tab" data-view="login">Accedi</button>' +
        '<button class="auth-tab auth-tab--active" data-view="signup">Registrati</button>' +
      '</div>' +
      '<div class="auth-message"></div>' +
      '<form class="auth-form" id="forgot-form">' +
        '<label>Email<br/><input type="email" name="email" required /></label>' +
        '<button type="submit" class="btn-auth">Invia link di reset</button>' +
      '</form>' +
      '<p class="auth-note">Riceverai un\'email con il link per scegliere una nuova password.</p>'
    );
    bindTabs();
    var form = app.querySelector('#forgot-form');
    form.addEventListener('submit', function(e){
      e.preventDefault();
      var email = form.email.value.trim();
      showMessage('Invio in corso…');
      supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://travirae.com/area-affiliati.html?mode=recovery'
      }).then(function(result){
        if (result.error){
          showMessage(result.error.message || 'Errore durante l\'invio del link', 'error');
          return;
        }
        showMessage('Email inviata. Controlla la posta e segui le istruzioni.', 'success');
      });
    });
  }

  function renderRecoveryView(){
    setContent(
      '<h2>Imposta una nuova password</h2>' +
      '<div class="auth-message"></div>' +
      '<form class="auth-form" id="recovery-form">' +
        '<label>Nuova password<br/><input type="password" name="password" required minlength="6" /></label>' +
        '<label>Conferma nuova password<br/><input type="password" name="password2" required minlength="6" /></label>' +
        '<button type="submit" class="btn-auth">Aggiorna password</button>' +
      '</form>'
    );
    var form = app.querySelector('#recovery-form');
    form.addEventListener('submit', function(e){
      e.preventDefault();
      var p1 = form.password.value.trim();
      var p2 = form.password2.value.trim();
      if (p1 !== p2){
        showMessage('Le password non coincidono', 'error');
        return;
      }
      showMessage('Aggiornamento in corso…');
      supabase.auth.updateUser({ password: p1 }).then(function(result){
        if (result.error){
          showMessage(result.error.message || 'Errore durante l\'aggiornamento della password', 'error');
          return;
        }
        showMessage('Password aggiornata! Ora puoi accedere con le nuove credenziali.', 'success');
        setTimeout(function(){ renderLoginView(); }, 1500);
      });
    });
  }

  function ensureAffiliate(user){
    return supabase
      .from('affiliates')
      .select('slug')
      .eq('user_id', user.id)
      .maybeSingle()
      .then(function(res){
        if (res.error){
          console.error('Errore recupero affiliate', res.error);
          return null;
        }
        if (res.data && res.data.slug) return res.data.slug;
        var base = (user.email || '').split('@')[0] || 'travirae';
        var clean = base.replace(/[^a-zA-Z0-9_-]/g, '').toLowerCase() || 'travirae';
        var slug = clean + '-' + Math.floor(Math.random()*10000);
        return supabase
          .from('affiliates')
          .insert({ user_id: user.id, slug: slug })
          .select('slug')
          .single()
          .then(function(result){
            if (result.error){
              console.error('Errore creazione affiliate', result.error);
              return null;
            }
            return result.data.slug;
          });
      });
  }

  function fetchStats(slug){
    var clicksPromise = supabase
      .from('affiliate_clicks')
      .select('*', { count: 'exact', head: true })
      .eq('affiliate_slug', slug)
      .then(function(res){ return res.count || 0; })
      .catch(function(){ return 0; });

    var payoutsPromise = supabase
      .from('monthly_affiliate_payouts')
      .select('*')
      .eq('affiliate_slug', slug)
      .order('month', { ascending: true })
      .then(function(res){ return res.data || []; })
      .catch(function(){ return []; });

    return Promise.all([clicksPromise, payoutsPromise]).then(function(values){
      var clicks = values[0];
      var payouts = values[1];
      var totalEarnings = 0;
      var currentMonthEarnings = 0;
      var now = new Date();
      var ymCurrent = now.toISOString().slice(0,7);
      payouts.forEach(function(row){
        var earnings = Number(row.affiliate_earnings || 0);
        totalEarnings += earnings;
        var ym = String(row.month || '').slice(0,7);
        if (ym === ymCurrent) currentMonthEarnings += earnings;
      });
      return { clicks: clicks, payouts: payouts, totalEarnings: totalEarnings, currentMonthEarnings: currentMonthEarnings };
    });
  }

  function formatUsd(n){
    var num = Number(n) || 0;
    return num.toFixed(2) + ' USD';
  }

  function renderDashboard(slug, stats){
    var baseUrl = 'https://travirae.com';
    var rows = '';
    (stats.payouts || []).forEach(function(row){
      var ym = String(row.month || '').slice(0,7);
      var share = Number(row.share_percent || 0) * 100;
      rows += '<tr>' +
        '<td>' + ym + '</td>' +
        '<td>' + (row.sales_count || 0) + '</td>' +
        '<td>' + formatUsd(row.net_commissions) + '</td>' +
        '<td>' + share.toFixed(0) + '%</td>' +
        '<td>' + formatUsd(row.affiliate_earnings) + '</td>' +
      '</tr>';
    });
    if (!rows){
      rows = '<tr><td colspan="5">Non ci sono ancora guadagni registrati.</td></tr>';
    }

    setContent(
      '<div class="dashboard-header">' +
        '<h2>La tua dashboard affiliato</h2>' +
        '<button type="button" class="logout-btn" id="logout-btn">Esci</button>' +
      '</div>' +
      '<div class="affiliate-id-box">' +
        '<p>Affiliate ID:</p>' +
        '<code>' + slug + '</code>' +
      '</div>' +
      '<div class="affiliate-links">' +
        '<h3>I tuoi link tracciati</h3>' +
        '<p class="small muted">Usa questo link unico per tutte le tue promozioni. Tutte le prenotazioni fatte sul sito dopo un clic saranno attribuite a te.</p>' +
        '<div class="affiliate-link-row">' +
          '<code class="affiliate-link-code">' + baseUrl + '/?ref=' + slug + '</code>' +
          '<button type="button" class="copy-btn" data-copy="' + baseUrl + '/?ref=' + slug + '">Copia</button>' +
        '</div>' +
      '</div>' +
      '<div class="stats-cards">' +
        '<div class="stats-card"><h4>Click ricevuti</h4><p class="stats-number">' + stats.clicks + '</p></div>' +
        '<div class="stats-card"><h4>Guadagno totale</h4><p class="stats-number">' + formatUsd(stats.totalEarnings) + '</p></div>' +
        '<div class="stats-card"><h4>Guadagno mese corrente</h4><p class="stats-number">' + formatUsd(stats.currentMonthEarnings) + '</p></div>' +
      '</div>' +
      '<div class="chart-wrapper">' +
        '<h3>Guadagni mensili</h3>' +
        '<canvas id="earnings-chart" height="120"></canvas>' +
        '<p class="chart-empty' + ((stats.payouts && stats.payouts.length) ? ' hidden' : '') + '">Il grafico sarà visibile quando avrai almeno un guadagno registrato.</p>' +
      '</div>' +
      '<div class="stats-table-wrapper">' +
        '<h3>Andamento mensile</h3>' +
        '<table class="stats-table">' +
          '<thead><tr>' +
            '<th>Mese</th><th>Vendite valide</th><th>Commissioni nette Travirae</th><th>Revenue share</th><th>Guadagno affiliato</th>' +
          '</tr></thead>' +
          '<tbody>' + rows + '</tbody>' +
        '</table>' +
      '</div>'
    );

    var logoutBtn = app.querySelector('#logout-btn');
    logoutBtn.addEventListener('click', function(){
      supabase.auth.signOut().then(function(){
        renderLoginView();
      });
    });

    var copyBtn = app.querySelector('.copy-btn');
    if (copyBtn){
      copyBtn.addEventListener('click', function(){
        var txt = copyBtn.getAttribute('data-copy');
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(function(){
            copyBtn.classList.add('copied');
            copyBtn.textContent = 'Copiato!';
            setTimeout(function(){
              copyBtn.classList.remove('copied');
              copyBtn.textContent = 'Copia';
            }, 1500);
          });
        } else {
          var tmp = document.createElement('textarea');
          tmp.value = txt;
          document.body.appendChild(tmp);
          tmp.select();
          try{ document.execCommand('copy'); }catch(e){}
          document.body.removeChild(tmp);
        }
      });
    }

    if (window.Chart && stats.payouts && stats.payouts.length){
      var labels = stats.payouts.map(function(r){ return String(r.month || '').slice(0,7); });
      var data = stats.payouts.map(function(r){ return Number(r.affiliate_earnings || 0); });
      var ctx = document.getElementById('earnings-chart');
      if (ctx){
        new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: [{ label: 'Guadagno affiliato (USD)', data: data, tension: 0.3 }] },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }
  }

  function showDashboard(){
    supabase.auth.getUser().then(function(res){
      var user = res.data && res.data.user;
      if (!user){
        renderLoginView();
        return;
      }
      ensureAffiliate(user).then(function(slug){
        if (!slug){
          renderLoginView('Errore nella creazione del tuo Affiliate ID, riprova più tardi.');
          return;
        }
        fetchStats(slug).then(function(stats){
          renderDashboard(slug, stats);
        });
      });
    });
  }

  function init(){
    if (!supabase){
      app.innerHTML = '<p>Errore di inizializzazione Supabase. Riprova tra poco.</p>';
      return;
    }
    var params = new URLSearchParams(window.location.search);
    var mode = params.get('mode') || params.get('type');
    var emailConfirmed = params.get('email_confirmed');

    if (mode === 'recovery'){
      renderRecoveryView();
      return;
    }
    supabase.auth.getUser().then(function(res){
      var user = res.data && res.data.user;
      if (user){
        showDashboard();
      } else {
        if (emailConfirmed){
          renderLoginView('Email confermata! Ora puoi accedere con le tue credenziali.');
        } else {
          renderLoginView();
        }
      }
    });
  }

  init();
})();
</script>
</body>
</html>
