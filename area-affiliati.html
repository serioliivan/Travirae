<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Area affiliati – Travirae</title>
  <link rel="icon" type="image/png" href="assets/img/common/plane-logo.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body class="page--affiliate-portal">
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="index.html" aria-label="Travirae Home">
      <img src="assets/img/common/plane-logo.png" alt="Travirae" style="height:28px"/>
      <span>Travirae</span>
    </a>
    <nav class="main-nav" aria-label="Navigazione principale">
      <a class="nav-link" href="index.html">Hotel</a>
      <a class="nav-link" href="flights.html">Voli</a>
      <a class="nav-link active" href="programma-affiliato.html">Programma affiliato</a>
    </nav>
    <button class="nav-toggle" aria-label="Apri menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>
</header>

<main>
  <section class="section">
    <div class="container auth-layout">
      <div class="auth-copy">
        <h1>Area affiliati Travirae</h1>
        <p>Qui gestisci il tuo Affiliate ID, i link tracciati e le statistiche delle prenotazioni generate tramite il tuo traffico.</p>
        <ul>
          <li>Revenue share dal <strong>40%</strong> al <strong>60%</strong> sulle commissioni nette Travirae.</li>
          <li>Click e vendite tracciate automaticamente tramite Travelpayouts e Stay22.</li>
          <li>Payout mensile a partire da <strong>50 USD</strong>.</li>
        </ul>
      </div>
      <div class="auth-card" id="auth-card">
        <!-- Login / dashboard vengono iniettati via JS -->
      </div>
    </div>
  </section>
</main>

<footer class="mega-footer">
  <div class="container mf-bottom muted small">
    <div>© <span id="year-copy"></span> Travirae · Tutti i diritti riservati</div>
    <div class="mf-legal">
      <a href="privacy.html">Privacy</a> · <a href="termini.html">Termini</a> · <a href="cookie.html">Cookie</a>
    </div>
  </div>
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://qihaslaxdfwounujpeuf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpaGFzbGF4ZGZ3b3VudWpwZXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzE5MTMsImV4cCI6MjA4MDYwNzkxM30.scqVi4SjN76Oqr3FVtHt5OZWcn8Zh7LyTgU-H4bNEdo';
  window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script defer src="assets/js/main.js"></script>
<script>
  (function(){
    const supabase = window.supabaseClient;
    const card = document.getElementById('auth-card');

    function renderLoginForm(message){
      card.innerHTML = `
        <h2>Accedi o registrati</h2>
        ${message ? `<p class="auth-message">${message}</p>` : ''}
        <form id="auth-form" class="auth-form">
          <label>Email<br/><input type="email" name="email" required /></label>
          <label>Password<br/><input type="password" name="password" required /></label>
          <button type="submit" class="btn">Accedi / Registrati</button>
        </form>
        <p class="auth-note">Se non hai ancora un account, lo creiamo al primo accesso.</p>
      `;

      const form = document.getElementById('auth-form');
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const email = form.email.value.trim();
        const password = form.password.value.trim();

        let { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password });
          if (signUpError) {
            renderLoginForm('Errore: ' + signUpError.message);
            return;
          }
          renderLoginForm('Registrazione completata. Ora accedi con le stesse credenziali.');
          return;
        }

        showDashboard();
      });
    }

    async function ensureAffiliate(user){
      const { data, error } = await supabase
        .from('affiliates')
        .select('slug')
        .eq('user_id', user.id)
        .maybeSingle();

      if (error) {
        console.error('Errore recupero affiliate', error);
        return null;
      }

      if (data && data.slug) return data.slug;

      const base = (user.email.split('@')[0] || 'affiliate')
        .replace(/[^a-zA-Z0-9_-]/g, '')
        .toLowerCase();
      const slug = base + '-' + Math.floor(Math.random() * 10000);

      const { data: inserted, error: insertError } = await supabase
        .from('affiliates')
        .insert({ user_id: user.id, slug })
        .select('slug')
        .single();

      if (insertError) {
        console.error('Errore creazione Affiliate ID', insertError);
        return null;
      }

      return inserted.slug;
    }

    async function fetchStats(slug){
      const { count: clicksCount } = await supabase
        .from('affiliate_clicks')
        .select('*', { count: 'exact', head: true })
        .eq('affiliate_slug', slug);

      const { data: payouts } = await supabase
        .from('monthly_affiliate_payouts')
        .select('*')
        .eq('affiliate_slug', slug)
        .order('month', { ascending: false });

      const allPayouts = payouts || [];
      let totalEarnings = 0;
      let currentMonthEarnings = 0;

      const now = new Date();
      const ymCurrent = now.toISOString().slice(0, 7);

      allPayouts.forEach(row => {
        const earnings = Number(row.affiliate_earnings || 0);
        totalEarnings += earnings;
        const ymRow = String(row.month).slice(0, 7);
        if (ymRow === ymCurrent) currentMonthEarnings += earnings;
      });

      return {
        clicks: clicksCount || 0,
        payouts: allPayouts,
        totalEarnings,
        currentMonthEarnings
      };
    }

    function formatUsd(n){
      return (Number(n) || 0).toFixed(2) + ' USD';
    }

    function renderDashboardView(slug, stats){
      const baseUrl = 'https://travirae.com';
      const rows = (stats.payouts || []).map(row => {
        const ym = String(row.month).slice(0, 7);
        const share = Number(row.share_percent || 0) * 100;
        return `
          <tr>
            <td>${ym}</td>
            <td>${row.sales_count || 0}</td>
            <td>${formatUsd(row.net_commissions)}</td>
            <td>${share.toFixed(0)}%</td>
            <td>${formatUsd(row.affiliate_earnings)}</td>
          </tr>
        `;
      }).join('') || `
        <tr><td colspan="5">Non ci sono ancora guadagni registrati.</td></tr>
      `;

      card.innerHTML = `
        <h2>La tua dashboard affiliato</h2>
        <div class="affiliate-id-box">
          <p>Affiliate ID:</p>
          <code>${slug}</code>
        </div>
        <div class="affiliate-links">
          <h3>I tuoi link tracciati</h3>
          <ul>
            <li><code>${baseUrl}/?ref=${slug}</code></li>
            <li><code>${baseUrl}/flights.html?ref=${slug}</code></li>
          </ul>
        </div>
        <div class="stats-cards">
          <div class="stats-card">
            <h4>Click ricevuti</h4>
            <p class="stats-number">${stats.clicks}</p>
          </div>
          <div class="stats-card">
            <h4>Guadagno totale</h4>
            <p class="stats-number">${formatUsd(stats.totalEarnings)}</p>
          </div>
          <div class="stats-card">
            <h4>Guadagno mese corrente</h4>
            <p class="stats-number">${formatUsd(stats.currentMonthEarnings)}</p>
          </div>
        </div>
        <div class="stats-table-wrapper">
          <h3>Andamento mensile</h3>
          <table class="stats-table">
            <thead>
              <tr>
                <th>Mese</th>
                <th>Vendite valide</th>
                <th>Commissioni nette Travirae</th>
                <th>Revenue share</th>
                <th>Guadagno affiliato</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    async function showDashboard(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        renderLoginForm();
        return;
      }

      const slug = await ensureAffiliate(user);
      if (!slug) {
        renderLoginForm('Errore nella creazione del tuo Affiliate ID. Riprova più tardi.');
        return;
      }

      const stats = await fetchStats(slug);
      renderDashboardView(slug, stats);
    }

    supabase.auth.getUser().then(({
      data
    }) => {
      if (data && data.user) showDashboard();
      else renderLoginForm();
    });
  })();
</script>
</body>
</html>
