<!DOCTYPE html>

<html lang="it">
<head>
<link href="assets/img/common/plane-logo.png" rel="icon" type="image/png"/>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Area affiliati – Programma affiliato Travirae</title>
<meta name="description" content="Accedi all'Area Affiliati Travirae per gestire il tuo Affiliate ID, generare link tracciati e monitorare click e guadagni mensili.">
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="assets/css/style.css"/>
<meta property="og:title" content="Area affiliati – Travirae"/>
<meta property="og:description" content="Dashboard affiliati Travirae: tracking link, click e guadagni mensili."/>
<meta property="og:image" content="assets/img/common/hero.jpg"/>
<meta name="twitter:image" content="assets/img/common/hero.jpg"/>
</head>
<body class="page--affiliate-portal">
<header class="site-header">
<div class="container header-inner">
<a class="brand" href="index.html" aria-label="Travirae Home">
<img src="assets/img/common/plane-logo.png" alt="Travirae" style="height:28px"/>
<span>Travirae</span>
</a>
<nav class="main-nav" aria-label="Navigazione principale">
<a class="nav-link" href="index.html">Hotel</a>
<a class="nav-link" href="flights.html">Voli</a>
<a class="nav-link" href="programma-affiliato.html">Programma affiliato</a>
</nav>
<button class="nav-toggle" aria-label="Apri menu" aria-expanded="false">
<span></span><span></span><span></span>
</button>
</div>
</header>
<main>
<section class="section">
<div class="container affiliate-portal-grid">
<div class="affiliate-intro">
<p class="muted small" style="margin:0 0 6px;">Programma Affiliato Travirae</p>
<h1>Area affiliati</h1>
<p class="subtitle">Gestisci il tuo Affiliate ID, genera link tracciati e controlla le performance mensili.</p>
<ul class="benefits-list">
<li>Ottieni un <strong>Affiliate ID univoco</strong> collegato al tuo account Supabase.</li>
<li>Condividi l'home page, le pagine hotel o voli usando il parametro <code>?ref=ID</code>.</li>
<li>Monitora <strong>click, vendite valide e guadagni mensili</strong> direttamente dalla dashboard.</li>
</ul>
<p class="muted small">Le statistiche si basano sulle tabelle <code>affiliate_clicks</code>, <code>bookings</code> e <code>monthly_affiliate_payouts</code> presenti su Supabase. Lo schema non viene modificato dal frontend.</p>
</div>
<div>
<div class="auth-card" id="affiliate-auth-card">
<div class="auth-card-header">
<h2 class="auth-card-title">Accedi o registrati</h2>
<p class="auth-card-subtitle">Entra nell'Area Affiliati per ottenere il tuo link tracciato e vedere le statistiche.</p>
</div>
<div class="auth-tabs" role="tablist">
<button type="button" class="auth-tab is-active" data-auth-tab="login">Accedi</button>
<button type="button" class="auth-tab" data-auth-tab="register">Registrati</button>
</div>
<div class="auth-views">
<div class="auth-view auth-view-login" data-view="login">
<form id="affiliate-login-form" class="auth-form" autocomplete="on">
<div class="form-group">
<label for="login-email">Email</label>
<input id="login-email" name="email" type="email" required/>
</div>
<div class="form-group">
<label for="login-password">Password</label>
<input id="login-password" name="password" type="password" required/>
</div>
<div class="auth-actions">
<button type="submit" class="btn">Accedi</button>
<button type="button" class="auth-link" id="affiliate-forgot-link">Password dimenticata?</button>
</div>
</form>
</div>
<div class="auth-view auth-view-register" data-view="register" hidden>
<form id="affiliate-register-form" class="auth-form" autocomplete="on">
<div class="form-group">
<label for="register-email">Email</label>
<input id="register-email" name="email" type="email" required/>
</div>
<div class="form-group">
<label for="register-password">Password</label>
<input id="register-password" name="password" type="password" required/>
</div>
<div class="form-group">
<label for="register-password-confirm">Conferma password</label>
<input id="register-password-confirm" name="password_confirm" type="password" required/>
</div>
<div class="auth-actions">
<button type="submit" class="btn">Crea account</button>
</div>
</form>
</div>
<div class="auth-view auth-view-forgot" data-view="forgot" hidden>
<form id="affiliate-forgot-form" class="auth-form">
<div class="form-group">
<label for="forgot-email">Email</label>
<input id="forgot-email" name="email" type="email" required/>
</div>
<div class="auth-actions">
<button type="submit" class="btn">Invia link reset</button>
<button type="button" class="auth-link" data-back-to="login">Torna al login</button>
</div>
</form>
</div>
<div class="auth-view auth-view-recovery" data-view="recovery" hidden>
<form id="affiliate-recovery-form" class="auth-form">
<p class="muted small">Hai aperto il link di ripristino password. Imposta di seguito una nuova password per il tuo account.</p>
<div class="form-group">
<label for="recovery-password">Nuova password</label>
<input id="recovery-password" name="password" type="password" required/>
</div>
<div class="form-group">
<label for="recovery-password-confirm">Conferma nuova password</label>
<input id="recovery-password-confirm" name="password_confirm" type="password" required/>
</div>
<div class="auth-actions">
<button type="submit" class="btn">Aggiorna password</button>
</div>
</form>
</div>
<div class="auth-view auth-view-dashboard" data-view="dashboard" hidden>
<div class="auth-card-header">
<h2 class="auth-card-title">Dashboard affiliato</h2>
<p class="auth-card-subtitle">Gestisci il tuo Affiliate ID e le performance del programma.</p>
</div>
<div class="affiliate-id-block">
<div class="muted small">Il tuo Affiliate ID</div>
<div class="affiliate-id-row">
<code id="affiliate-slug"></code>
</div>
<div class="affiliate-link-row">
<label for="affiliate-link-input" class="muted small">Link principale da condividere</label>
<div class="affiliate-link-input-row">
<input id="affiliate-link-input" type="text" readonly/>
<button type="button" class="btn" id="affiliate-copy-btn">Copia</button>
</div>
</div>
</div>
<div class="affiliate-stats-grid">
<div class="stat-card">
<div class="stat-label">Click totali</div>
<div class="stat-value" id="affiliate-stat-clicks">—</div>
</div>
<div class="stat-card">
<div class="stat-label">Guadagno totale</div>
<div class="stat-value" id="affiliate-stat-total">—</div>
</div>
<div class="stat-card">
<div class="stat-label">Guadagno mese corrente</div>
<div class="stat-value" id="affiliate-stat-month">—</div>
</div>
</div>
<div class="affiliate-chart-card">
<h3>Guadagni mensili</h3>
<div style="height:220px;">
<canvas id="affiliate-payouts-chart" aria-label="Grafico guadagni mensili affiliato"></canvas>
</div>
</div>
<div class="affiliate-table-card">
<h3>Storico payout mensili</h3>
<table class="table affiliate-payouts-table">
<thead>
<tr>
<th>Mese</th>
<th>Vendite valide</th>
<th>Commissioni nette</th>
<th>Revenue share</th>
<th>Guadagno per te</th>
</tr>
</thead>
<tbody id="affiliate-payouts-table-body">
<tr><td colspan="5" class="muted small">Nessun payout registrato finora.</td></tr>
</tbody>
</table>
</div>
<div class="affiliate-dashboard-actions">
<button type="button" class="btn" id="affiliate-logout-btn">Esci</button>
</div>
</div>
</div>
<div id="affiliate-auth-message" class="auth-message" aria-live="polite"></div>
</div>
</div>
</section>
</main>

<footer class="mega-footer">
<div class="container mf-grid">
<div class="mf-brand">
<div class="brand big">
<img src="assets/img/common/plane-logo.png" alt="Travirae" style="height:28px"/>
<span>Travirae</span>
</div>
<p class="muted">La tua piattaforma di ispirazione e prenotazione hotel con mappa interattiva.</p>
<div class="mf-socials">
  <a class="social social--icon" href="https://www.instagram.com/travirae.official/" aria-label="Instagram" target="_blank" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg" alt="" loading="lazy"/>
  </a>
  <a class="social social--icon" href="https://www.facebook.com/profile.php?id=615587037940606" aria-label="Facebook" target="_blank" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="" loading="lazy"/>
  </a>
  <a class="social social--icon" href="https://www.tiktok.com/@travirae?lang=en" aria-label="TikTok" target="_blank" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a6/Tiktok_icon.svg" alt="" loading="lazy"/>
  </a>
  <a class="social social--icon" href="https://www.youtube.com/channel/UCgGtp3qTHUzMPqjpT8EnRbQ" aria-label="YouTube" target="_blank" rel="noopener">
    <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg" alt="" loading="lazy"/>
  </a>
</div>
</div>
<nav class="mf-links">
<h4>Esplora</h4>
<ul>
<li><a href="index.html">Hotel</a></li>
<li><a href="flights.html">Voli</a></li>
<li><a href="programma-affiliato.html">Programma affiliato</a></li>
</ul>
</nav>
<nav class="mf-services">
<h4>Servizi</h4>
<ul>
<li><a href="flights.html">Voli</a></li>
<li><a href="index.html">Hotel</a></li>
<li><a href="programma-affiliato.html">Programma affiliato</a></li>
</ul>
</nav>
<div class="mf-contact">
<h4>Resta in contatto</h4>
<ul class="contact-list">
<li>✉️ info@travirae.example</li>
<li>Iscriviti alla nostra newsletter</li>
</ul>
<form class="newsletter-form wide" name="newsletter" method="POST" data-netlify="true">
<input type="email" name="email" aria-label="Email per newsletter" placeholder="La tua email" required/>
<button class="btn" type="submit">Iscriviti</button>
</form>
</div>
</div>
<div class="container mf-bottom muted small">
<div>© <span id="year-copy"></span> Travirae · Tutti i diritti riservati</div>
<div class="mf-legal">
<a href="privacy.html">Privacy</a> · <a href="termini.html">Termini</a> · <a href="cookie.html">Cookie</a>
</div>
</div>
</footer>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://qihaslaxdfwounujpeuf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpaGFzbGF4ZGZ3b3VudWpwZXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzE5MTMsImV4cCI6MjA4MDYwNzkxM30.scqVi4SjN76Oqr3FVtHt5OZWcn8Zh7LyTgU-H4bNEdo';
window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/main.js"></script>
<script>
(function(){
  function $(sel, root){ return (root || document).querySelector(sel); }
  function $all(sel, root){ return Array.prototype.slice.call((root || document).querySelectorAll(sel)); }

  function init(){
    if (!document.body.classList.contains('page--affiliate-portal')) return;

    var supa = window.supabaseClient || null;
    var state = { user: null, affiliate: null, slug: null, chart: null };

    var tabsContainer = $('.auth-tabs');
    var tabButtons = $all('.auth-tab');
    var views = {
      login: $('.auth-view-login'),
      register: $('.auth-view-register'),
      forgot: $('.auth-view-forgot'),
      recovery: $('.auth-view-recovery'),
      dashboard: $('.auth-view-dashboard')
    };
    var authMessageEl = $('#affiliate-auth-message');
    var logoutBtn = $('#affiliate-logout-btn');

    function refreshClient(){
      if (!supa && window.supabaseClient){ supa = window.supabaseClient; }
      return supa;
    }

    function setMessage(text, type){
      if (!authMessageEl) return;
      authMessageEl.textContent = text || '';
      authMessageEl.classList.remove('is-error','is-success');
      if (type === 'error') authMessageEl.classList.add('is-error');
      else if (type === 'success') authMessageEl.classList.add('is-success');
    }

    function showView(name){
      Object.keys(views).forEach(function(key){
        var el = views[key];
        if (!el) return;
        if (key === name) el.removeAttribute('hidden');
        else el.setAttribute('hidden','hidden');
      });
      if (tabsContainer){
        tabButtons.forEach(function(btn){
          var tab = btn.getAttribute('data-auth-tab');
          btn.classList.toggle('is-active', name === tab);
        });
      }
    }

    function getQueryParam(name){
      try {
        var params = new URLSearchParams(window.location.search || '');
        return params.get(name);
      } catch(e){ return null; }
    }

    function getInitialView(){
      var v = (getQueryParam('view') || '').toLowerCase();
      if (v === 'register' || v === 'login') return v;
      var h = (window.location.hash || '').toLowerCase();
      if (h.indexOf('registr') !== -1) return 'register';
      if (h.indexOf('accedi') !== -1 || h.indexOf('login') !== -1) return 'login';
      return 'login';
    }

    function formatMoney(value){
      var n = Number(value || 0);
      if (!isFinite(n)) n = 0;
      try{
        return n.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }catch(e){
        return n.toFixed(2);
      }
    }

    function formatMonthLabel(iso){
      if (!iso) return '';
      try{
        var d = new Date(iso);
        var m = d.getMonth() + 1;
        var y = d.getFullYear();
        return (m < 10 ? '0'+m : m) + '/' + y;
      }catch(e){
        return iso;
      }
    }

    async function ensureAffiliateForUser(user){
      var client = refreshClient();
      if (!client || !client.from) return null;
      try {
        var resp = await client
          .from('affiliates')
          .select('user_id,slug')
          .eq('user_id', user.id)
          .limit(1);

        if (resp.error){ console.warn('Errore caricamento affiliate', resp.error); }
        if (resp.data && resp.data.length){ return resp.data[0]; }

        var email = (user.email || '').split('@')[0] || 'partner';
        var base = email.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        if (!base) base = 'partner';
        var rand = Math.floor(Math.random()*9000) + 1000;
        var slug = (base + '-' + rand).substring(0,64);

        var insertResp = await client
          .from('affiliates')
          .insert({ user_id: user.id, slug: slug })
          .select('user_id,slug')
          .limit(1);

        if (insertResp.error){
          console.error('Errore creazione affiliate', insertResp.error);
          return null;
        }
        if (insertResp.data && insertResp.data.length){
          return insertResp.data[0];
        }
        return { user_id: user.id, slug: slug };
      } catch(e){
        console.error('Errore imprevisto ensureAffiliateForUser', e);
        return null;
      }
    }

    function bindTabs(){
      if (!tabsContainer) return;
      tabButtons.forEach(function(btn){
        btn.addEventListener('click', function(){
          var tab = btn.getAttribute('data-auth-tab');
          if (tab === 'login' || tab === 'register'){
            showView(tab);
            setMessage('', null);
          }
        });
      });
    }

    function bindForms(){
      var loginForm = $('#affiliate-login-form');
      if (loginForm){
        loginForm.addEventListener('submit', async function(e){
          e.preventDefault();
          setMessage('', null);
          var client = refreshClient();
          if (!client || !client.auth){
            setMessage('Servizio di autenticazione non disponibile. Riprova tra poco.', 'error');
            return;
          }
          var email = (loginForm.querySelector('input[name="email"]') || {}).value || '';
          var password = (loginForm.querySelector('input[name="password"]') || {}).value || '';
          try {
            var result = await client.auth.signInWithPassword({ email: email, password: password });
            var data = result && result.data;
            var error = result && result.error;
            if (error){
              setMessage(error.message || 'Credenziali non valide.', 'error');
              return;
            }
            state.user = data && data.user ? data.user : null;
            if (!state.user && data && data.session && data.session.user){
              state.user = data.session.user;
            }
            if (!state.user){
              setMessage('Accesso riuscito, ma impossibile recuperare i dati utente.', 'error');
              return;
            }
            setMessage('Accesso effettuato.', 'success');
            await initDashboard();
          } catch(err){
            console.error(err);
            setMessage('Errore durante il login. Riprova tra poco.', 'error');
          }
        });
      }

      var registerForm = $('#affiliate-register-form');
      if (registerForm){
        registerForm.addEventListener('submit', async function(e){
          e.preventDefault();
          setMessage('', null);
          var client = refreshClient();
          if (!client || !client.auth){
            setMessage('Servizio di autenticazione non disponibile. Riprova tra poco.', 'error');
            return;
          }
          var email = (registerForm.querySelector('input[name="email"]') || {}).value || '';
          var password = (registerForm.querySelector('input[name="password"]') || {}).value || '';
          var confirm = (registerForm.querySelector('input[name="password_confirm"]') || {}).value || '';
          if (!email || !password){
            setMessage('Compila email e password.', 'error');
            return;
          }
          if (password !== confirm){
            setMessage('Le password non coincidono.', 'error');
            return;
          }
          try {
            var result = await client.auth.signUp({
              email: email,
              password: password,
              options: {
                emailRedirectTo: 'https://travirae.com/area-affiliati.html?email_confirmed=1'
              }
            });
            var error = result && result.error;
            if (error){
              setMessage(error.message || 'Errore durante la registrazione.', 'error');
              return;
            }
            setMessage('Registrazione completata! Controlla la tua email per confermare l'indirizzo prima di accedere.', 'success');
            showView('login');
          } catch(err){
            console.error(err);
            setMessage('Errore imprevisto durante la registrazione.', 'error');
          }
        });
      }

      var forgotLink = $('#affiliate-forgot-link');
      if (forgotLink){
        forgotLink.addEventListener('click', function(e){
          e.preventDefault();
          showView('forgot');
          setMessage('', null);
        });
      }

      var forgotForm = $('#affiliate-forgot-form');
      if (forgotForm){
        forgotForm.addEventListener('submit', async function(e){
          e.preventDefault();
          setMessage('', null);
          var client = refreshClient();
          if (!client || !client.auth){
            setMessage('Servizio di autenticazione non disponibile. Riprova tra poco.', 'error');
            return;
          }
          var email = (forgotForm.querySelector('input[name="email"]') || {}).value || '';
          if (!email){
            setMessage('Inserisci la tua email.', 'error');
            return;
          }
          try {
            var result = await client.auth.resetPasswordForEmail(email, {
              redirectTo: 'https://travirae.com/area-affiliati.html?mode=recovery'
            });
            var error = result && result.error;
            if (error){
              setMessage(error.message || 'Errore durante il reset password.', 'error');
              return;
            }
            setMessage('Se l'indirizzo esiste nel sistema, riceverai una email con il link per reimpostare la password.', 'success');
            showView('login');
          } catch(err){
            console.error(err);
            setMessage('Errore imprevisto durante il recupero password.', 'error');
          }
        });
      }

      var backToLoginBtn = document.querySelector('.auth-view-forgot [data-back-to="login"]');
      if (backToLoginBtn){
        backToLoginBtn.addEventListener('click', function(e){
          e.preventDefault();
          showView('login');
          setMessage('', null);
        });
      }

      var recoveryForm = $('#affiliate-recovery-form');
      if (recoveryForm){
        recoveryForm.addEventListener('submit', async function(e){
          e.preventDefault();
          setMessage('', null);
          var client = refreshClient();
          if (!client || !client.auth){
            setMessage('Servizio di autenticazione non disponibile. Riprova tra poco.', 'error');
            return;
          }
          var password = (recoveryForm.querySelector('input[name="password"]') || {}).value || '';
          var confirm = (recoveryForm.querySelector('input[name="password_confirm"]') || {}).value || '';
          if (!password){
            setMessage('Inserisci una nuova password.', 'error');
            return;
          }
          if (password !== confirm){
            setMessage('Le password non coincidono.', 'error');
            return;
          }
          try {
            var result = await client.auth.updateUser({ password: password });
            var error = result && result.error;
            if (error){
              setMessage(error.message || 'Errore durante l'aggiornamento della password.', 'error');
              return;
            }
            setMessage('Password aggiornata con successo! Ora puoi accedere con le nuove credenziali.', 'success');
            showView('login');
          } catch(err){
            console.error(err);
            setMessage('Errore imprevisto durante l'aggiornamento della password.', 'error');
          }
        });
      }

      if (logoutBtn){
        logoutBtn.addEventListener('click', async function(){
          var client = refreshClient();
          if (client && client.auth){
            try { await client.auth.signOut(); } catch(e){ console.warn('Errore durante il logout', e); }
          }
          state.user = null;
          state.affiliate = null;
          state.slug = null;
          if (state.chart && typeof state.chart.destroy === 'function'){
            state.chart.destroy();
          }
          setMessage('Sei uscito dall'area affiliati.', 'success');
          showView('login');
        });
      }
    }

    function updateDashboardHeader(){
      var slugEl = $('#affiliate-slug');
      var linkInput = $('#affiliate-link-input');
      if (!state.affiliate || !state.affiliate.slug) return;
      state.slug = state.affiliate.slug;
      var slug = state.slug;
      var baseUrl = 'https://travirae.com/';
      var refUrl = baseUrl + '?ref=' + encodeURIComponent(slug);

      if (slugEl) slugEl.textContent = slug;
      if (linkInput) linkInput.value = refUrl;

      var copyBtn = $('#affiliate-copy-btn');
      if (copyBtn && linkInput){
        copyBtn.addEventListener('click', function(){
          try { linkInput.select(); linkInput.setSelectionRange(0, 99999); } catch(e){}
          if (navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(linkInput.value)
              .then(function(){ setMessage('Link copiato negli appunti.', 'success'); })
              .catch(function(){ setMessage('Copia non riuscita, seleziona e copia manualmente.', 'error'); });
          } else {
            try {
              var ok = document.execCommand('copy');
              setMessage(ok ? 'Link copiato negli appunti.' : 'Copia non riuscita, seleziona e copia manualmente.', ok ? 'success' : 'error');
            } catch(e){
              setMessage('Seleziona il link e copialo manualmente.', 'error');
            }
          }
        });
      }
    }

    function renderChart(payouts){
      var canvas = $('#affiliate-payouts-chart');
      if (!canvas || !window.Chart) return;
      var ctx = canvas.getContext('2d');
      if (state.chart && typeof state.chart.destroy === 'function'){
        state.chart.destroy();
      }
      var labels = [];
      var values = [];
      payouts.forEach(function(row){
        labels.push(formatMonthLabel(row.month));
        values.push(Number(row.affiliate_earnings || 0));
      });
      state.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Guadagni mensili',
            data: values,
            tension: 0.25,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updatePayoutsTable(payouts){
      var tbody = $('#affiliate-payouts-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!payouts || !payouts.length){
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'muted small';
        td.textContent = 'Nessun payout registrato finora.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      payouts.forEach(function(row){
        var tr = document.createElement('tr');
        function createCell(text){
          var td = document.createElement('td');
          td.textContent = text;
          return td;
        }
        tr.appendChild(createCell(formatMonthLabel(row.month)));
        tr.appendChild(createCell(String(row.sales_count || 0)));
        tr.appendChild(createCell(formatMoney(row.net_commissions || 0)));
        tr.appendChild(createCell((row.share_percent != null ? row.share_percent + '%' : '')));
        tr.appendChild(createCell(formatMoney(row.affiliate_earnings || 0)));
        tbody.appendChild(tr);
      });
    }

    async function loadDashboardStats(){
      var client = refreshClient();
      if (!state.slug || !client || !client.from) return;
      try{
        var slug = state.slug;
        var clicksPromise = client
          .from('affiliate_clicks')
          .select('id', { count: 'exact' })
          .eq('affiliate_slug', slug);
        var payoutsPromise = client
          .from('monthly_affiliate_payouts')
          .select('month,sales_count,net_commissions,share_percent,affiliate_earnings')
          .eq('affiliate_slug', slug)
          .order('month', { ascending: true });

        var results = await Promise.all([clicksPromise, payoutsPromise]);
        var clicksResp = results[0];
        var payoutsResp = results[1];

        if (clicksResp.error){ console.warn('Errore caricamento click affiliato', clicksResp.error); }
        if (payoutsResp.error){ console.warn('Errore caricamento payouts affiliato', payoutsResp.error); }

        var clickCount = 0;
        if (!clicksResp.error){
          if (typeof clicksResp.count === 'number') clickCount = clicksResp.count;
          else if (Array.isArray(clicksResp.data)) clickCount = clicksResp.data.length;
        }

        var payouts = Array.isArray(payoutsResp.data) ? payoutsResp.data : [];
        var total = 0;
        var thisMonthTotal = 0;
        var now = new Date();
        var cy = now.getFullYear();
        var cm = now.getMonth();

        payouts.forEach(function(row){
          var v = Number(row.affiliate_earnings || 0);
          if (!isFinite(v)) v = 0;
          total += v;
          try{
            var d = new Date(row.month);
            if (d.getFullYear() === cy && d.getMonth() === cm){
              thisMonthTotal += v;
            }
          }catch(e){}
        });

        var clicksEl = $('#affiliate-stat-clicks');
        var totalEl = $('#affiliate-stat-total');
        var monthEl = $('#affiliate-stat-month');
        if (clicksEl) clicksEl.textContent = String(clickCount);
        if (totalEl) totalEl.textContent = formatMoney(total);
        if (monthEl) monthEl.textContent = formatMoney(thisMonthTotal);

        updatePayoutsTable(payouts);
        renderChart(payouts);
      } catch(e){
        console.error('Errore imprevisto caricamento statistiche affiliate', e);
      }
    }

    async function initDashboard(){
      var client = refreshClient();
      if (!client || !client.auth){
        showView('login');
        return;
      }
      if (!state.user){
        try{
          var resp = await client.auth.getUser();
          if (resp && resp.data && resp.data.user){
            state.user = resp.data.user;
          }
        }catch(e){
          console.warn('Errore getUser durante initDashboard', e);
        }
      }
      if (!state.user){
        showView('login');
        return;
      }
      var aff = await ensureAffiliateForUser(state.user);
      if (!aff){
        setMessage('Errore nel recupero del profilo affiliato. Riprova più tardi.', 'error');
        showView('login');
        return;
      }
      state.affiliate = aff;
      updateDashboardHeader();
      showView('dashboard');
      await loadDashboardStats();
    }

    // --- bootstrap ---
    bindTabs();
    bindForms();

    var mode = getQueryParam('mode');
    if (mode === 'recovery'){
      showView('recovery');
      setMessage('Imposta una nuova password per il tuo account.', null);
      return;
    }

    var initialView = getInitialView();
    showView(initialView);

    var client = refreshClient();
    if (!client || !client.auth){
      return;
    }

    client.auth.getUser()
      .then(function(resp){
        if (resp && resp.data && resp.data.user){
          state.user = resp.data.user;
          initDashboard();
        }
      })
      .catch(function(e){
        console.warn('Errore nel recupero utente iniziale', e);
      });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
