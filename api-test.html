<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="assets/css/styles.css">
<title>API Test</title>
<script>
async function readCfg(){ const r=await fetch('config/app.json'); return r.json(); }
function join(base, path){
  base=(base||'').replace(/\/+$/,'');
  if(/\/\.netlify\/functions\/proxy$/.test(base) || /\/api\/proxy$/.test(base)) return base+path;
  if(/\/api$/.test(base)) return base + path.replace(/^\/api/,'');
  return base+path;
}
async function negotiate(base){
  const roots=[base.replace(/\/+$/,''), base.replace(/\/api\/proxy$/,''), base.replace(/\/\.netlify\/functions\/proxy$/,''), base.replace(/\/api$/,'')];
  const tried=new Set(), out=[];
  for(const r of roots){
    const url = join(r, '/api/ping');
    if(tried.has(url)) continue; tried.add(url);
    try{ const resp=await fetch(url); const text=await resp.text(); let js; try{js=JSON.parse(text)}catch{js={'raw':text}}; out.push({url,status:resp.status,body:js}); if(resp.ok && js && js.ok) return {effective:r, attempts:out}; }catch(e){ out.push({url, error:String(e)}); }
  }
  return {effective:null, attempts:out};
}
async function run(kind){
  const cfg=await readCfg();
  const nego=await negotiate(cfg.API_BASE);
  const base=nego.effective||cfg.API_BASE;
  let url;
  if(kind==='ping'){ url = join(base,'/api/ping'); }
  if(kind==='auto'){ url = join(base,'/api/airports/suggest')+'?q=mil&locale='+(cfg.LOCALE_DEFAULT||'it'); }
  if(kind==='price'){ const u=new URL(join(base,'/api/flights/search')); u.searchParams.set('origin','MXP'); u.searchParams.set('destination','LHR'); u.searchParams.set('depart', new Date(Date.now()+21*86400000).toISOString().slice(0,10)); u.searchParams.set('currency', cfg.CURRENCY_DEFAULT||'EUR'); u.searchParams.set('limit','5'); url=u.toString(); }
  const r=await fetch(url); const text=await r.text(); let js; try{js=JSON.parse(text)}catch{js={'raw':text}};
  const pre=document.getElementById('out');
  pre.textContent=JSON.stringify({API_BASE:cfg.API_BASE,effective_base:base,attempts:nego.attempts,request:url,status:r.status,body:js},null,2);
}
</script></head><body>
<main class="container">
  <h1>API Test</h1>
  <div class="card">
    <div class="controls">
      <button class="btn btn-primary" onclick="run('ping')">Ping</button>
      <button class="btn btn-primary" onclick="run('auto')">Autocomplete “mil”</button>
      <button class="btn btn-primary" onclick="run('price')">Ricerca MXP→LHR</button>
    </div>
    <pre id="out" style="white-space:pre-wrap;background:#0a1126;border:1px solid #1b2e59;border-radius:12px;padding:12px;margin-top:12px;color:#cfe6ff;min-height:180px"></pre>
  </div>
</main>
</body></html>
